name: Test ECS Scaler

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  AWS_REGION: us-east-1
  PYTHON_VERSION: '3.9'

jobs:
  test-ecs-scaler:
    name: Test ECS Scaler with Real AWS
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    - name: Validate Configuration
      run: |
        echo "Validating ECS scaler configuration..."
        npx serverless print --config serverless.yml
        
    - name: Run Code Quality Checks
      run: |
        echo "Running code quality checks..."
        python -m flake8 src/ tests/
        python -m black --check src/ tests/
        
    - name: Run Unit Tests
      run: |
        echo "Running unit tests..."
        python -m pytest tests/ -v
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: |
          *.log
          test-results/
          
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          let testOutput = 'Test completed';
          
          try {
            if (fs.existsSync('automated-test.py.log')) {
              testOutput = fs.readFileSync('automated-test.py.log', 'utf8');
            }
          } catch (error) {
            console.log('Could not read test log');
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸ§ª ECS Scaler Test Results
            
            **Status**: âœ… Tests completed
            
            <details>
            <summary>Test Output</summary>
            
            \`\`\`
            ${testOutput}
            \`\`\`
            
            </details>
            
            The ECS scaler has been tested with real AWS services and is ready for use! ðŸš€`
          });
